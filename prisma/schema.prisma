generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatusEnum {
  ACTIVE
  UNACTIVE
  BLOCKED
}

// User
model User {
  id                    Int                  @id @default(autoincrement())
  roleID                Int
  name                  String?
  avatar                String?
  email                 String
  phone                 String?
  password              String?
  status                UserStatusEnum       @default(ACTIVE)
  oauthProvider         String?
  oauthID               String?
  isDeleted             Boolean              @default(false)
  createdAt             DateTime             @default(now())
  createdBy             Int?
  updatedAt             DateTime?            @updatedAt
  updatedBy             Int?
  PasswordReset         PasswordReset[]
  Role                  Role                 @relation(fields: [roleID], references: [id], onDelete: Cascade)
  SellerProfile         SellerProfile?
  Address               Address[]
  ProductLike           ProductLike[]
  ProductReview         ProductReview[]
  ProductComment        ProductComment[]
  ProductCommentLike    ProductCommentLike[]
  ShopStaff             ShopStaff[]
  ShopFollower          ShopFollower[]
  ShopReview            ShopReview[]
  sentNotifications     Notification[]       @relation("SentNotifications")
  receivedNotifications Notification[]       @relation("ReceivedNotifications")

  @@unique([email, oauthProvider])
}

model Address {
  id        Int       @id @default(autoincrement())
  user      User      @relation(fields: [userID], references: [id])
  userID    Int
  fullName  String
  phone     String?
  province  String?
  district  String?
  ward      String?
  street    String?
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model PasswordReset {
  userID    Int      @unique
  otpHash   String
  createdAt DateTime @default(now())
  expiresAt DateTime
  attempt   Int      @default(0)
  used      Boolean  @default(false)
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userID], references: [id], onDelete: Cascade)

  @@index([userID])
  @@index([expiresAt])
}

// Permission
model Role {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  description String?
  permissions RolePermission[]
  User        User[]
}

model Permission {
  id                          Int                           @id @default(autoincrement())
  code                        String                        @unique
  description                 String?
  roles                       RolePermission[]
  ShopStaffPermissionOverride ShopStaffPermissionOverride[]
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       Int
  permissionId Int
  isActive     Boolean    @default(true)
  permission   Permission @relation(fields: [permissionId], references: [id])
  role         Role       @relation(fields: [roleId], references: [id])

  @@unique([roleId, permissionId])
}

// End Permission

enum SellerStatusEnum {
  PENDING
  REJECTED
  APPROVED
  SUSPENDED
  BLOCKED
}

// Seller
model SellerProfile {
  id                Int                 @id @default(autoincrement())
  user              User                @relation(fields: [userID], references: [id], onDelete: Cascade)
  userID            Int                 @unique
  companyName       String
  brandName         String?
  businessPhone     String?
  businessAddress   String?
  description       String?
  status            SellerStatusEnum    @default(PENDING)
  rejectionReason   String?
  avgRating         Float               @default(0)
  totalReviews      Int                 @default(0)
  totalFollowers    Int                 @default(0)
  createdAt         DateTime            @default(now())
  createdBy         Int
  updatedAt         DateTime?           @updatedAt
  updatedBy         Int?
  SellerKycDocument SellerKycDocument[]
  ShopStaff         ShopStaff[]
  ShopFollower      ShopFollower[]
  ShopReview        ShopReview[]

  @@index([status])
}

// ShopStaff
model ShopStaff {
  id                          Int                           @id @default(autoincrement())
  user                        User                          @relation(fields: [userID], references: [id], onDelete: Cascade)
  userID                      Int
  seller                      SellerProfile                 @relation(fields: [sellerID], references: [id], onDelete: Cascade)
  sellerID                    Int
  createdAt                   DateTime                      @default(now())
  ShopStaffPermissionOverride ShopStaffPermissionOverride[]

  @@unique([userID, sellerID])
}

model ShopStaffPermissionOverride {
  id           Int        @id @default(autoincrement())
  staff        ShopStaff  @relation(fields: [staffID], references: [id], onDelete: Cascade)
  staffID      Int
  permission   Permission @relation(fields: [permissionID], references: [id], onDelete: Cascade)
  permissionID Int

  isAllowed Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([staffID, permissionID])
}

// End ShopStaff
model ShopFollower {
  id        Int           @id @default(autoincrement())
  user      User          @relation(fields: [userID], references: [id], onDelete: Cascade)
  userID    Int
  seller    SellerProfile @relation(fields: [sellerID], references: [id], onDelete: Cascade)
  sellerID  Int
  createdAt DateTime      @default(now())

  @@unique([userID, sellerID]) // 1 user chỉ follow 1 shop 1 lần
}

model ShopReview {
  id       Int           @id @default(autoincrement())
  user     User          @relation(fields: [userID], references: [id], onDelete: Cascade)
  userID   Int
  seller   SellerProfile @relation(fields: [sellerID], references: [id], onDelete: Cascade)
  sellerID Int

  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  ReviewShopImage ReviewShopImage[]
}

model ReviewShopImage {
  id           Int        @id @default(autoincrement())
  shopReview   ShopReview @relation(fields: [shopReviewID], references: [id], onDelete: Cascade)
  shopReviewID Int

  url       String
  filename  String
  mimeType  String?
  size      Int?
  createdAt DateTime @default(now())
}

enum KycDocumentType {
  ID_CARD_FRONT
  ID_CARD_BACK
  BUSINESS_LICENSE
  FOOD_SAFETY_CERT
}

model SellerKycDocument {
  id        Int             @id @default(autoincrement())
  sellerID  Int
  seller    SellerProfile   @relation(fields: [sellerID], references: [id], onDelete: Cascade)
  type      KycDocumentType
  url       String
  filename  String
  mimeType  String?
  size      Int?
  createdAt DateTime        @default(now())

  @@unique([sellerID, type])
}

// Category nè
model CategoryShop {
  id               Int             @id @default(autoincrement())
  sellerID         Int
  slug             String
  name             String
  description      String?
  categoryGlobalId Int?
  CategoryGlobal   CategoryGlobal? @relation(fields: [categoryGlobalId], references: [id], onDelete: Cascade)
  Product          Product[]
}

model CategoryGlobal {
  id           Int            @id @default(autoincrement())
  name         String
  slug         String         @unique
  description  String?
  CategoryShop CategoryShop[]
  Product      Product[]
}

enum Region {
  MIEN_BAC
  MIEN_TRUNG
  MIEN_NAM
  TAY_NGUYEN
}

enum Condition {
  FRESH
  PROCESSED
  DRIED
}

enum Season {
  SPRING
  SUMMER
  AUTUMN
  WINTER
}

// Product
model Product {
  id               Int  @id @default(autoincrement())
  sellerID         Int
  categoryGlobalID Int
  categoryShopID   Int?

  title               String
  slug                String
  description         String?
  origin              String?
  brand               String?
  unit                String?
  region              Region[]
  condition           Condition[]
  season              Season[]
  storageInstructions String?
  usageInstructions   String?
  certifications      String?
  stock               Int         @default(0)
  minOrderQty         Int         @default(1)
  basePrice           Float

  // Thống kê
  isActive     Boolean @default(true)
  isFeatured   Boolean @default(false) // sản phẩm nổi bật (admin )
  soldCount    Int     @default(0) // số lượng đã bán
  viewCount    Int     @default(0) // số lượt xem
  totalReviews Int     @default(0) // số lượt review
  avgRating    Float   @default(0) // trung bình sao

  createdAt DateTime  @default(now())
  createdBy Int
  updatedAt DateTime? @updatedAt
  updatedBy Int?

  CategoryGlobal CategoryGlobal @relation(fields: [categoryGlobalID], references: [id], onDelete: Cascade)

  CategoryShop   CategoryShop?    @relation(fields: [categoryShopID], references: [id], onDelete: Cascade)
  ProductImage   ProductImage[]
  PricingTier    PricingTier[]
  ProductLike    ProductLike[]
  ProductReview  ProductReview[]
  ProductComment ProductComment[]
}

model ProductImage {
  id        Int      @id @default(autoincrement())
  product   Product  @relation(fields: [productID], references: [id], onDelete: Cascade)
  productID Int
  fileName  String?
  mimeType  String?
  url       String
  altText   String?
  isMain    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([productID])
}

model PricingTier {
  id        Int     @id @default(autoincrement())
  product   Product @relation(fields: [productID], references: [id], onDelete: Cascade)
  productID Int

  minQty    Int
  price     Int
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model ProductLike {
  id        Int      @id @default(autoincrement())
  product   Product  @relation(fields: [productID], references: [id], onDelete: Cascade)
  productID Int
  user      User     @relation(fields: [userID], references: [id], onDelete: Cascade)
  userID    Int
  createdAt DateTime @default(now())

  @@unique([productID, userID])
}

model ProductComment {
  id                  Int                   @id @default(autoincrement())
  product             Product               @relation(fields: [productID], references: [id], onDelete: Cascade)
  productID           Int
  user                User                  @relation(fields: [userID], references: [id], onDelete: Cascade)
  userID              Int
  content             String?
  createdAt           DateTime              @default(now())
  ProductCommentLike  ProductCommentLike[]
  ProductCommentImage ProductCommentImage[]
}

model ProductCommentLike {
  id               Int            @id @default(autoincrement())
  productComment   ProductComment @relation(fields: [productCommentID], references: [id], onDelete: Cascade)
  productCommentID Int
  user             User           @relation(fields: [userID], references: [id], onDelete: Cascade)
  userID           Int
  createdAt        DateTime       @default(now())
}

model ProductCommentImage {
  id               Int            @id @default(autoincrement())
  productComment   ProductComment @relation(fields: [productCommentID], references: [id], onDelete: Cascade)
  productCommentID Int
  url              String
  filename         String
  mimeType         String?
  size             Int?
  createdAt        DateTime       @default(now())
}

model ProductReview {
  id        Int     @id @default(autoincrement())
  product   Product @relation(fields: [productID], references: [id], onDelete: Cascade)
  productID Int
  user      User    @relation(fields: [userID], references: [id], onDelete: Cascade)
  userID    Int

  rating             Int?
  content            String?
  createdAt          DateTime             @default(now())
  ReviewProductImage ReviewProductImage[]
}

model ReviewProductImage {
  id              Int           @id @default(autoincrement())
  productReview   ProductReview @relation(fields: [productReviewID], references: [id], onDelete: Cascade)
  productReviewID Int

  url       String
  filename  String
  mimeType  String?
  size      Int?
  createdAt DateTime @default(now())
}

// End Product

// Notification
enum NotificationType {
  ORDER_STATUS
  SYSTEM_SALE
  NEW_PRODUCT
  CUSTOM
}

model Notification {
  id         Int              @id @default(autoincrement())
  senderID   Int? // Ai gửi (user/shop/system)
  receiverID Int? // Ai nhận (null = broadcast toàn hệ thống)
  type       NotificationType
  title      String
  content    String
  metadata   Json? // Dữ liệu động (vd: { orderId: 123, status: "SHIPPED" })
  isRead     Boolean          @default(false)
  createdAt  DateTime         @default(now())
  sender     User?            @relation("SentNotifications", fields: [senderID], references: [id], onDelete: Cascade)
  receiver   User?            @relation("ReceivedNotifications", fields: [receiverID], references: [id], onDelete: Cascade)
}
